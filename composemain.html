<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSS - Compose</title>
    <link rel="icon" href="media/etc/IMG_2701-removebg-preview.png">
    <style>
        @import url(style/STYLE_Chatbot.css);
        @import url(style/STYLE_composemain.css);
    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <a href="home.html"><img src="media/etc/logo.png" alt="Logo"></a>
        </div>
        <div class="buttons">
            <button class="save-button">Save</button>
            <button class="publish-button">Publish</button>
        </div>
    </header>
    <main>
        <div class="controls">
            <button class="control-button play">Play</button>
            <button class="control-button stop">Stop</button>
            <button class="control-button reset">Reset</button>
            <button class="control-button record">Record</button>
        </div>
        <div class="main-content">
            <div class="instrument-panel">
                <button class="add-track-button" onclick="showInstrumentModal()">+Add Track</button>
                <div id="instrument-controls"></div>
            </div>
            <div class="composition-area" id="composition-area"></div>
        </div>
        <div class="instrument-display hidden">
            <div class="instrument-select"></div>
            <div class="instrument-list" id="instrument-list"></div>
        </div>
    </main>

    <div id="instrument-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="hideInstrumentModal()">&times;</span>
            <h3>Select Instrument</h3>
            <button class="instrument-button" onclick="addInstrument('Piano')">Piano</button>
            <button class="instrument-button" onclick="addInstrument('Drum')">Drum</button>
        </div>
    </div>

      <button class="chatbot-toggler">
        <span class="material-symbols-rounded" style="margin-left: 8px;">mode_comment</span>
        <h4 style="margin-left: 40px;">Assistant</h4>
        <span class="material-symbols-outlined">close</span>
      </button>
      <div class="chatbot">
        <a href="easteregg.html"><header>
          <h2>Assistant</h2>
          <p>Powered by Gemini</p>
          <span class="close-btn material-symbols-outlined">close</span>
        </header></a>
        <a href="easteregg.html"><ul class="chatbox">
          <li class="chat incoming">
            <span class="material-symbols-outlined">smart_toy</span>
            <p>Hi there ğŸ‘‹<br>How can I help you today?</p>
          </li>
        </ul></a>
        <div class="chat-input">
          <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
          <span id="send-btn" class="material-symbols-rounded">send</span>
        </div>
      </div>
    
      <!-- ì±—ë´‡ ìŠ¤í¬ë¦½íŠ¸ -->
      <script type="module">
        // Google Generative AI ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
        import { GoogleGenerativeAI } from "@google/generative-ai";
        
        // Generative AI ì´ˆê¸°í™” ë° API í‚¤ ì„¤ì •
        const genAI = new GoogleGenerativeAI('AIzaSyAUOyuSGwGGOp_YTo1xjLoXt6DgXw8jh7A');
    
        // ì±—ë´‡ ê¸°ëŠ¥ì— í•„ìš”í•œ DOM ìš”ì†Œ ì„ íƒ
        const chatbotToggler = document.querySelector(".chatbot-toggler"); // ì±—ë´‡ í† ê¸€ ë²„íŠ¼
        const closeBtn = document.querySelector(".close-btn"); // ì±—ë´‡ ë‹«ê¸° ë²„íŠ¼
        const chatbox = document.querySelector(".chatbox"); // ì±„íŒ… ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ì˜ì—­
        const chatInput = document.querySelector(".chat-input textarea"); // ì‚¬ìš©ì ì…ë ¥ë€
        const sendChatBtn = document.querySelector(".chat-input span"); // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼
    
        // ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ ë³€ìˆ˜ ë° ì…ë ¥ë€ ì´ˆê¸° ë†’ì´ ì €ì¥
        let userMessage = null;
        const inputInitHeight = chatInput.scrollHeight;
    
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë©”ì‹œì§€ë¡œ ëª¨ë¸ ì‹¤í–‰
        async function runModel(prompt) {
            const model = genAI.getGenerativeModel({ model: "gemini-pro"}); // ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
          
            // ì‚¬ìš©ì ë©”ì‹œì§€ë¡œ ì½˜í…ì¸  ìƒì„±
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            return (text); // ìƒì„±ëœ í…ìŠ¤íŠ¸ ë°˜í™˜
        }
        
        // ì±„íŒ… ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ í•­ëª© ìƒì„±
        const createChatLi = (message, className) => {
            const chatLi = document.createElement("li"); // ìƒˆë¡œìš´ ë¦¬ìŠ¤íŠ¸ í•­ëª© ìƒì„±
            chatLi.classList.add("chat", `${className}`); // í´ë˜ìŠ¤ ì¶”ê°€
            // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë‚´ìš© ì„¤ì •
            let chatContent = className === "outgoing" ? `<p></p>` : `<span class="material-symbols-outlined">smart_toy</span><p></p>`;
            chatLi.innerHTML = chatContent; // HTML ì„¤ì •
            chatLi.querySelector("p").textContent = message; // ë©”ì‹œì§€ ë‚´ìš© ì„¤ì •
            return chatLi; // ë¦¬ìŠ¤íŠ¸ í•­ëª© ë°˜í™˜
        }
    
        // ì±—ë´‡ ì‘ë‹µ ìƒì„±
        const generateResponse = async (chatElement, userMessage) => {
            const messageElement = chatElement.querySelector("p");
            try {
                const answer = await runModel(userMessage); // ëª¨ë¸ ì‹¤í–‰í•˜ì—¬ ì‘ë‹µ ìƒì„±
                messageElement.textContent = answer; // ì‘ë‹µ ë‚´ìš© ì„¤ì •
            } catch (error) {
                // ì˜¤ë¥˜ ì²˜ë¦¬
                console.error("Failed to generate response;", error);
                messageElement.textContent = "Sorry, something went wrong."; // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            }
            chatbox.scrollTo(0, chatbox.scrollHeight); // ì±„íŒ… ë°•ìŠ¤ë¥¼ ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
        }
    
        // ì±„íŒ… ì²˜ë¦¬
        const handleChat = () => {
            userMessage = chatInput.value.trim(); // ì‚¬ìš©ì ì…ë ¥ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
            if(!userMessage) return; // ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë°˜í™˜
            
            // ì…ë ¥ë€ ì´ˆê¸°í™” ë° ë†’ì´ ì¬ì„¤ì •
            chatInput.value = "";
            chatInput.style.height = `${inputInitHeight}px`;
    
            // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì±„íŒ… ë°•ìŠ¤ì— ì¶”ê°€
            chatbox.appendChild(createChatLi(userMessage, "outgoing"));
            chatbox.scrollTo(0, chatbox.scrollHeight);
    
            setTimeout(() => {
                // ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ "Thinking..." ë©”ì‹œì§€ í‘œì‹œ
                const incomingChatLi = createChatLi("Thinking...", "incoming");
                chatbox.appendChild(incomingChatLi);
                chatbox.scrollTo(0, chatbox.scrollHeight);
                generateResponse(incomingChatLi, userMessage); // ì‘ë‹µ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
            }, 0); // ì‘ë‹µ ìƒì„± ì§€ì—°ì‹œê°„ ì„¤ì •
        }
    
        // ì…ë ¥ë€ ë‚´ìš© ê¸¸ì´ì— ë”°ë¼ ë†’ì´ ì¡°ì ˆ
        chatInput.addEventListener("input", () => {
            chatInput.style.height = `${inputInitHeight}px`; // ì´ˆê¸° ë†’ì´ë¡œ ì¬ì„¤ì •
            chatInput.style.height = `${chatInput.scrollHeight}px`; // ìƒˆë¡œìš´ ë‚´ìš©ì— ë§ê²Œ ë†’ì´ ì¡°ì ˆ
        });
    
        // Enter í‚¤ë¥¼ ëˆŒëŸ¬ ì±„íŒ… ì²˜ë¦¬
        chatInput.addEventListener("keydown", (e) => {
            if(e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) { // Shift í‚¤ë¥¼ ëˆ„ë¥´ì§€ ì•Šê³  Enter í‚¤ë¥¼ ëˆŒë €ìœ¼ë©° ì°½ ë„ˆë¹„ê°€ 800px ì´ìƒì¸ ê²½ìš°
                e.preventDefault(); // ê¸°ë³¸ Enter í‚¤ ë™ì‘ ë°©ì§€
                handleChat(); // ì±„íŒ… ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
            }
        });
    
        // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ… ì²˜ë¦¬
        sendChatBtn.addEventListener("click", handleChat);
    
        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì±—ë´‡ ë‹«ê¸°
        closeBtn.addEventListener("click", () => document.body.classList.remove("show-chatbot"));
    
        // í† ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ ì±—ë´‡ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
        chatbotToggler.addEventListener("click", () => document.body.classList.toggle("show-chatbot"));
    
    </script>

    <script src="javascript/scripts.js"></script>

</body>
</html>
